<!-- Main Layout with Header and Sidebar -->
<div class="app-layout" *ngIf="showLayout">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-left">
      <div class="user-info">
        <div class="user-avatar" (click)="showProfileMenu = !showProfileMenu" style="cursor: pointer;">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%234CAF50'/%3E%3Ctext x='20' y='28' font-size='20' text-anchor='middle' fill='white'%3Eع%3C/text%3E%3C/svg%3E" alt="User Avatar">
        </div>
        <div class="user-details">
          <div class="user-name">{{ currentUser?.fullName || currentUser?.username || userName }}</div>
          <div class="user-role">{{ userRole }}</div>
        </div>
      </div>
      
      <!-- Profile Dropdown Menu -->
      <div class="profile-menu" *ngIf="showProfileMenu" (click)="$event.stopPropagation()">
        <div class="profile-menu-header">
          <div class="profile-menu-avatar">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%234CAF50'/%3E%3Ctext x='20' y='28' font-size='20' text-anchor='middle' fill='white'%3Eع%3C/text%3E%3C/svg%3E" alt="User Avatar">
          </div>
          <div class="profile-menu-info">
            <div class="profile-menu-name">{{ currentUser?.fullName || currentUser?.username || userName }}</div>
            <div class="profile-menu-email">{{ currentUser?.email || 'لا يوجد بريد إلكتروني' }}</div>
          </div>
        </div>
        <div class="profile-menu-divider"></div>
        <button class="profile-menu-item" (click)="logout()">
          <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
            <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
          </svg>
          <span>تسجيل الخروج</span>
        </button>
      </div>
    </div>
    <div class="header-center">
      <div class="header-icons">
        <div class="icon-item">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
          </svg>
        </div>
        <div class="icon-item">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
          </svg>
        </div>
        <div class="icon-item notification-badge">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
          </svg>
          <span class="badge">{{ notificationsCount }}</span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="logo">مرقاب Mirqab</div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="dashboard-content">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a routerLink="/dashboard" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="sidebar-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z"/>
        </svg>
        <span class="sidebar-tooltip">الرئيسية</span>
      </a>
      <a routerLink="/projects" routerLinkActive="active" class="sidebar-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
          <path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.958 0 1.553.69 1.907 1.184L8.5 5.5h5a.5.5 0 0 1 .5.5v7a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 1 12.5v-9zM2.5 3a.5.5 0 0 0-.5.5V12a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V6h-5a.5.5 0 0 1-.5-.5V3.5a.5.5 0 0 0-.5-.5h-3z"/>
          <path d="M6 7.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5z"/>
        </svg>
        <span class="sidebar-tooltip">المشاريع</span>
      </a>
      <a routerLink="/projects-progress" routerLinkActive="active" class="sidebar-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
          <path d="M9.5 0a.5.5 0 0 1 .5.5v1.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 .5-.5zm-3 11c.828 0 1.5-.672 1.5-1.5S7.328 8 6.5 8 5 8.672 5 9.5 5.672 11 6.5 11zm2.56-1.854a.5.5 0 0 1 .434.314l1.414 3.924a.5.5 0 0 1-.434.736H4.851a.5.5 0 0 1-.434-.736l1.414-3.924a.5.5 0 0 1 .434-.314h3.39ZM9.5 3h-3a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5ZM5 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zM3.5 2h.5a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1Zm2 0h.5a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1Zm2 0h.5a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1Zm2 0h.5a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1Zm2 0h.5a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1Z"/>
        </svg>
        <span class="sidebar-tooltip">تقدم المشاريع</span>
      </a>
      <a routerLink="/users" routerLinkActive="active" class="sidebar-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
        </svg>
        <span class="sidebar-tooltip">المستخدمين</span>
      </a>
    </aside>

    <!-- Page Content -->
    <main class="main-content-wrapper">
      <!-- Dashboard Content (only on dashboard route) -->
      <div class="dashboard-container" *ngIf="showDashboard">
        <!-- Main Cards Grid -->
        <div class="cards-grid">
          <!-- Tasks Card -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg width="20" height="20" fill="#4CAF50" viewBox="0 0 16 16">
                  <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                </svg>
                <span>المهام</span>
              </div>
              <div class="notification-badge-small">{{ tasksNotificationCount }}</div>
            </div>
            <div class="card-body">
              <div class="chart-placeholder">
                <div *ngIf="isLoadingMilestones" class="loading-text">جاري تحميل المهام...</div>
                <svg *ngIf="!isLoadingMilestones" width="100%" height="100" viewBox="0 0 300 100" preserveAspectRatio="none">
                  <polyline [attr.points]="chartPoints || '0,80 30,80 60,80 90,80 120,80 150,80 180,80 210,80 240,80 270,80 300,80'" 
                            fill="none" stroke="#4CAF50" stroke-width="2"/>
                </svg>
              </div>
              <div class="stats-row">
                <div class="stat-item">
                  <div class="stat-label">عدد المهام في العام الحالي</div>
                  <div class="stat-value">{{ taskStats.currentYear }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">عدد المهام في عام 2004</div>
                  <div class="stat-value">{{ taskStats.year2004 }}</div>
                </div>
              </div>
              <div class="card-footer">
                <a (click)="navigateToMilestoneDetails()" class="more-link" style="cursor: pointer;">المزيد ←</a>
              </div>
            </div>
          </div>

          <!-- Reports Card -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                <span>التقارير ولوحات التحكم</span>
              </div>
            </div>
            <div class="card-body">
              <div class="reports-section">
                <div class="report-category">
                  <div class="category-title">تقارير الأمن السيبراني</div>
                  <ul class="report-list">
                    <li *ngFor="let report of cybersecurityReports">{{ report.title }}</li>
                  </ul>
                </div>
                <div class="report-category">
                  <div class="category-title">تقارير المشاريع</div>
                  <ul class="report-list">
                    <li *ngFor="let report of projectReports">{{ report.title }}</li>
                  </ul>
                </div>
              </div>
              <div class="card-footer">
                <a href="#" class="more-link">المزيد ←</a>
              </div>
            </div>
          </div>

          <!-- Projects Card -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M11 2a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3h6zM5 1a4 4 0 0 0-4 4v6a4 4 0 0 0 4 4h6a4 4 0 0 0 4-4V5a4 4 0 0 0-4-4H5z"/>
                </svg>
                <span>الاستراتيجية وإدارة المشاريع</span>
              </div>
              <div class="notification-badge-small">{{ projectsNotificationCount }}</div>
            </div>
            <div class="card-body">
              <div class="project-stats">
                <div class="project-stat-item">
                  <div class="project-stat-value">{{ projectStats.inProgress }}</div>
                  <div class="project-stat-label">
                    <span>مشروع قيد العمل</span>
                    <svg width="16" height="16" fill="#ff4444" viewBox="0 0 16 16">
                      <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.06 4h9.883c.716 0 1.175 1.013.609 1.658L8.753 11.14a.5.5 0 0 1-.506 0z"/>
                    </svg>
                  </div>
                </div>
                <div class="project-stat-item">
                  <div class="project-stat-value">{{ projectStats.completed }}</div>
                  <div class="project-stat-label">
                    <span>مشروع مكتمل</span>
                    <svg width="16" height="16" fill="#4CAF50" viewBox="0 0 16 16">
                      <path d="M7.247 4.86l-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/>
                    </svg>
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <a (click)="navigateToProjectsProgress()" class="more-link" style="cursor: pointer;">المزيد ←</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2 -->
        <div class="cards-grid">
          <!-- Meeting Agenda Card -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                </svg>
                <span>أجندة الاجتماعات</span>
              </div>
            </div>
            <div class="card-body">
              <div class="meetings-list">
                <div *ngFor="let meeting of meetings" class="meeting-item">
                  <div class="meeting-title">{{ meeting.title }}</div>
                  <div class="meeting-time">{{ meeting.time }}</div>
                  <div class="meeting-location">{{ meeting.location }}</div>
                  <div class="meeting-link">{{ meeting.link }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- News Card -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M0 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h2zm2-1a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1h-2V2a1 1 0 0 0-1-1H2zm13 2v5H3V4z"/>
                </svg>
                <span>الأخبار</span>
              </div>
            </div>
            <div class="card-body">
              <div class="news-list">
                <div *ngFor="let item of news" class="news-item">
                  <div class="news-title">{{ item.title }}</div>
                  <div class="news-date">{{ item.date }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Other Pages Content (via router outlet) -->
      <div *ngIf="!showDashboard" class="page-content">
        <router-outlet></router-outlet>
      </div>
    </main>
  </div>
</div>

<!-- Login Page (no layout) - Always show router-outlet when layout is hidden or not yet determined -->
<div *ngIf="showLayout === false || showLayout === undefined">
  <router-outlet></router-outlet>
</div>

<!-- Toast Component -->
<app-toast></app-toast>
